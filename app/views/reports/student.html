<!-- Author: David Norris (22690264), Lara Posel (22972221) -->
{% extends 'templates/auth_area.html' %}
{% set active_page = 'student' %}

{% import "macros/charts.jinja" as charts %}

{% block head %}
    {{ charts.chart_head(data, '') }}
{% endblock %}

{% block content %}

<script>
  // function makePDF(studentNumber, unitValues) {
  // const url = `/reports/student/pdf/${studentNumber}/${unitValues}`;
  // const windowName = "PDF Report";
  // const windowSpecs = "toolbar=no,menubar=no,location=no,scrollbars=yes,resizable=yes,width=800,height=600";

  // // Open new window with the rendered template
  // let pdfWindow = window.open(url, windowName, windowSpecs);

  // Wait for the window to finish loading before creating the PDF

//  }

  const downloadFile = (blob, fileName) => {
            // Author David Norris (22690264),
            const link = document.createElement('a');
            // make blobURI that points to blob
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            // for compatibility, some browsers require a link
            document.body.append(link);
            link.click();
            link.remove();
            // save memory if blob is using a lot
            setTimeout(() => URL.revokeObjectURL(link.href), 7000);
          };

          const makePDF = (studentNumber, unitValues) => {
              // Author David Norris (22690264), Sean Ledesma (22752771)
              let printWindow = window.open(`/reports/student/pdf/${studentNumber}/${unitValues}`, '', 'height=1000,width=1000');
              printWindow.onload = () => {
                  let chartImg = printWindow.document.getElementById('chartImage');
                  const awaitChart = () => {
                      // we need the charts api to of converted image to uri in img.src
                      if (chartImg.src === '') {
                          // timeout to come back in 50 ms and don't exec until re-test
                          setTimeout(awaitChart, 50);
                          return;
                      }
                      fetch('/makepdf', {
                          method: 'POST',
                          headers: {
                            'Accept': 'application/pdf',
                            'Content-Type': 'text/html'
                          },
                          body: printWindow.document.getElementById('wrapper').innerHTML
                      })
                      .then((response) => {
                          printWindow.close();
                          return response.blob();
                      })
                      .then((data) => {
                          downloadFile(data, `Report-Student-${studentNumber}-${unitValues}.pdf`);
                      })
                  };
                  awaitChart();
              };
          }
</script>

<style>
  .highlight {
      background-color: #ccbb22;
  }
</style>

<div class='row'>
  <h3 class='title' style="display:inline-block"><small>Student Report:</small> {{data.student.name}} ({{(data.student.student_number|string).zfill(8)}})</h3>
  <a href='/reports/student'><button class="backButton" style="float: right">Back to search</button></a>
  <a><button onclick="makePDF('{{student_number}}', '{{unit_values}}')">Download PDF</button></a>
</div>
<div class='row'>
    <div class='three columns vertical-fill'>
        <div class='card'>
            <h5>Core</h5>
            <table class='u-full-width'>
                <tr>
                  <th>Total</th>
                  <td>{{data.graph.total  | round(2, 'common') }}</td>
                </tr>
                <tr>
                  <th>Remaining</th>
                    <td>{{[(data.units[0] - data.graph.total), 0] | max  | round(2, 'common') }}</td>
                </tr>
            </table>
        </div>
        <div class='card'>
            <h5>CHECK</h5>
            <h4>{{ 'PASSED' if ((data.units[0] - data.graph.total) <= 0) else 'UNPASSED' }}</h2>
        </div>
        <div class='card'>
          <h5>Selected Units</h5>
          <table>
            <thead>
              <tr>
                <th>
                  Units
                </th>
                <td>Hours Done</td>
              </tr>
            </thead>
          {% for unit_names in data.results%}
            <tr>
              <th>{{unit_names[0]}}</th>
              <td>{{unit_names[1] | round(2, 'common')}}</td>
            </tr>
          {% endfor %}
          </table>
        </div>
    </div>
    <div class='nine columns vertical-fill'>
      <div class='card'>
        <h5>HOURS BY PLACEMENT LOCATION</h5>
        <table class="u-full-width placement-location-table">
          <thead>
            <tr>
              <th>Location</th>
              <th>Hours</th>
            </tr>
          </thead>
          <tbody>
            {% for location in data.locations %}
            <tr>
              <td>{{ location.location }}</td>
              <td>{{ location.hours | round(2, 'common') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class='card'>
        <h5>HOURS BY ACTIVITY AND AES DOMAIN</h5>
        <table class="u-full-width activity-aep-table">
            <thead>
                <tr>
                    <th colspan="5" style="text-align: center;">Activity Type</th>
                    <th>Total</th>
                </tr>
                <tr>
                    <th>AES Domains</th>
                    {% for activity in data.activity_names %}
                    <th>{{activity.activity}}</th>
                    {% endfor %}
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for domain in data.domains %}
                <tr>
                    <td>{{domain.domain}}</td>
                    {% for activity in data.activity_names %}
                    {% if domain[activity.activityid] == 0 %}
                    <td>{{domain[activity.activityid] | round(2, 'common')}}</td>
                    {% else %}
                    <td class="highlight">{{domain[activity.activityid] | round(2, 'common')}}</td>
                    {% endif %}
                    {% endfor %}
                    {% if domain.total == 0 %}
                    <td>{{domain.total | round(2, 'common')}}</td>
                    {% else %}
                    <td class="highlight">{{domain.total | round(2, 'common')}}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                <tr>
                    <td>{{data.total_row.domain}}</td>
                    {% for activity in data.activity_names %}
                    {% if data.total_row[activity.activityid] == 0 %}
                    <td>{{data.total_row[activity.activityid] | round(2, 'common')}}</td>
                    {% else %}
                    <td class="highlight">{{data.total_row[activity.activityid] | round(2, 'common')}}</td>
                    {% endif %}
                    {% endfor %}
                    {% if data.total_row.total == 0 %}
                    <td>{{data.total_row.total | round(2, 'common')}}</td>
                    {% else %}
                    <td class="highlight">{{data.total_row.total | round(2, 'common')}}</td>
                    {% endif %}
                </tr>
            </tbody>
        </table>
      </div>
    </div>
</div>
<div class='row'>
    <div class='twelve columns card'>
        {{ charts.chart_div()}}
    </div>
</div>

{% endblock %}
